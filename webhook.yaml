apiVersion: apps/v1
kind: Deployment
metadata:
  name: immutable-checker
  namespace: default
  labels:
    app: immutable-checker
spec:
  replicas: 1
  selector:
    matchLabels:
      app: immutable-checker
  template:
    metadata:
      labels:
        app: immutable-checker
    spec:
      containers:
        - name: immutable-checker
          image: kanatakita/immutable-checker:latest
          args:
            - -tls-cert-file=/etc/webhook/certs/cert.pem
            - -tls-key-file=/etc/webhook/certs/key.pem
            - -policy-file=/etc/webhook/policy/policy.conf
          volumeMounts:
            - name: webhook-certs
              mountPath: /etc/webhook/certs
              readOnly: true
            - name: webhook-policy
              mountPath: /etc/webhook/policy
              readOnly: true
      volumes:
        - name: webhook-certs
          secret:
            secretName: immutable-checker.default.svc
        - name: webhook-policy
          configMap:
            name: immutable-checker.default.svc
---
apiVersion: v1
kind: Service
metadata:
  name: immutable-checker
  namespace: default
  labels:
    app: immutable-checker
spec:
  ports:
  - port: 443
    targetPort: 8080
  selector:
    app: immutable-checker
---
apiVersion: v1
kind: Secret
metadata:
  name: immutable-checker.default.svc
  namespace: default
data:
  cert.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZ5VENDQTdHZ0F3SUJBZ0lKQUpEenhaSThFdVZaTUEwR0NTcUdTSWIzRFFFQkJRVUFNQ2d4SmpBa0JnTlYKQkFNTUhXbHRiWFYwWVdKc1pTMWphR1ZqYTJWeUxtUmxabUYxYkhRdWMzWmpNQjRYRFRJd01ESXhPREEyTlRFMApOVm9YRFRRM01EY3dOakEyTlRFME5Wb3dkVEVMTUFrR0ExVUVCaE1DU2xBeERqQU1CZ05WQkFnTUJXUjFiVzE1Ck1RNHdEQVlEVlFRSERBVmtkVzF0ZVRFT01Bd0dBMVVFQ2d3RlpIVnRiWGt4RGpBTUJnTlZCQXNNQldSMWJXMTUKTVNZd0pBWURWUVFEREIxcGJXMTFkR0ZpYkdVdFkyaGxZMnRsY2k1a1pXWmhkV3gwTG5OMll6Q0NBaUl3RFFZSgpLb1pJaHZjTkFRRUJCUUFEZ2dJUEFEQ0NBZ29DZ2dJQkFMRGttNVlKTHZxNjZUVFVVMFlRL2lKN0cwNWU1T0RoCmFZMVRnY2FBVFY1V0U0cUp3OHc1cFdsRE1qeis1V2prNTV3eW1KVmkxbG94NW03RHlTb2ZNaEp6T0JPbC9lWWMKT2V3ZzhCZ0JoeWhRZHZMMHhaUHN5SUxmWHhTelF3NWxrQ1FoSW1Mai9uVndCNGpQY05UQjlRbWV6SFRnV1J6dQpENUR1bGMyZU9MMEovWUFhUWw1cW9lNzlDY1NGMnQyakJJdUxkUTFYUzlIQWRjWkF5RXVpRGtCM1pIeFpmTzhKCmdESzVuMVpjY0phK1hibUpnSHFRNmNYNFV5aFNrMnpOMEprRW5FbmdBNDVHRnBzSEM3WmxCKzU1R3RVYXh2M1gKa0J3L0R5a3pRbS9zNXFwR2VZY1RsY3B3Z1ZMdEJtL01LVmsyMFh2M2Z1U0FsOVNjNDdUTjZIazkwV3NNOW5PYQpyT0ZZV0EwcVNnelk4MmxYSnVydS9tMVI2YUl3VitIaTdxa1RBc1hjbHVVUlJITVMvNCsvVUwwK1VQcEpoR0N3CjlzTmo2cGphanBVYXQrZ1BmbkJHcmFzV1NORXNBckY1TmlOaDNFRUl1T0k5dHpxOXFaeTRQdHVuTStoTnZQTTAKUW5teTU1djRjUDBCTlNqQmVuWTdsNFBRU25GamtLYkdOVXdacC9aSkVwSkQyQ2NYb0FsWURxdFBVTnZGQWxuUgpCRmY3RlJWeGFZREpWWFU0WFZobXB4eG1EMjdFYWpnTFJWVFRhQmlLOGFaVEVBOG9lWCsrYVEwUUsrRndhL01tCldFZzFnZmpnTDJqTE9iTXlkRWJHY3FaVmVLZlpkMHorNFkxNGMwaG1Md2VLOXdUbmwvd0l5VUlaNnpCazhSYkoKR1lYQmNPdkJrNkFoQWdNQkFBR2pnYWd3Z2FVd1FnWURWUjBqQkRzd09hRXNwQ293S0RFbU1DUUdBMVVFQXd3ZAphVzF0ZFhSaFlteGxMV05vWldOclpYSXVaR1ZtWVhWc2RDNXpkbU9DQ1FEcXBFcGpVNUhDcVRBSkJnTlZIUk1FCkFqQUFNQXNHQTFVZER3UUVBd0lFTURBZEJnTlZIU1VFRmpBVUJnZ3JCZ0VGQlFjREFRWUlLd1lCQlFVSEF3SXcKS0FZRFZSMFJCQ0V3SDRJZGFXMXRkWFJoWW14bExXTm9aV05yWlhJdVpHVm1ZWFZzZEM1emRtTXdEUVlKS29aSQpodmNOQVFFRkJRQURnZ0lCQUhlQUlVNmV3NVNhV2dHNjR5N2Z5S2U1V2hBTHdDM2xxdm41MVl1bEJNL3l4WmFjCitIMGRoM3dYUVkybTVra1E0dDM2SVdhNkNyV25KSnhUZ2xwWTF4Q1k3dHhLSGxUNUpmaG44Y09tQ2NuRmRjOHkKWDhZNEpGc3F2Q3dpYStmWkZnckRYUmptUU11c0MwbUltalgwTEh3VzUvN091dmtkN2lLazFoR1VkUWpuVmU0WQpQMis3ck9maGY1Rk1VekNtdzlqalNiaDBxYWlwNTZBb1Q1MWRjanU1MHhRMnMwTkhjT3lNdXFNb0tZNEg1ZHQzClhremQ5cWozczVQMENXRWVkVHZQREhJV0hIZFdqeG1LVklsbi9XU3VrWGZlNGswaXQvdENJUjk3a1pUZWFkSWsKR1QzeG1LZGh4Q3RDVEtVS2VrUjVSSkJwQk1zblJ4bmRpbVhSQ0pJMGpiSUl6QmlTM2s3Z1dkeVZ2V2hMT0M5YwpMZVJtTjFwUXB3cEhNSHhEN0RmTEpUSzF2TVpiK1RDWUdzc0prM2NydGU4bytGYkQveld4emJabkxSbllwem1vCnptc0E3dW9ab3BleHJkVmNUUzJGWkVWMG5aOE12UFBwdFZ5S3BWYjVjRmRqbFVVSkx0UzR1NnhxSmRCSmZ1YUQKZVA0ZnpCYVAyazhFN09YZm1Rb3pkajNmWFdQdStXNDl1ZlgrTDVwRGNWWW4vK2tMV0pGYUl4UFZRNE90ZlZmMQo5Q0lTWldaY3BLTWtVbkNiUU1iM014UWljb1AzMkdNb1lBamRua3lmU0tPMEUzUFphYk9vNS9iR3hQanFCN1U0Ck0yU09ucklzbTNCYUhzQkJyZ1JKaDZubVpBNVdVMTcwTm5CYjF4dE1hTjQ1eURUeGY3S1lzRjJmd1V6cAotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  key.pem: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKS0FJQkFBS0NBZ0VBc09TYmxna3UrcnJwTk5SVFJoRCtJbnNiVGw3azRPRnBqVk9CeG9CTlhsWVRpb25ECnpEbWxhVU15UFA3bGFPVG5uREtZbFdMV1dqSG1ic1BKS2g4eUVuTTRFNlg5NWh3NTdDRHdHQUdIS0ZCMjh2VEYKayt6SWd0OWZGTE5ERG1XUUpDRWlZdVArZFhBSGlNOXcxTUgxQ1o3TWRPQlpITzRQa082VnpaNDR2UW45Z0JwQwpYbXFoN3YwSnhJWGEzYU1FaTR0MURWZEwwY0IxeGtESVM2SU9RSGRrZkZsODd3bUFNcm1mVmx4d2xyNWR1WW1BCmVwRHB4ZmhUS0ZLVGJNM1FtUVNjU2VBRGprWVdtd2NMdG1VSDdua2ExUnJHL2RlUUhEOFBLVE5DYit6bXFrWjUKaHhPVnluQ0JVdTBHYjh3cFdUYlJlL2QrNUlDWDFKemp0TTNvZVQzUmF3ejJjNXFzNFZoWURTcEtETmp6YVZjbQo2dTcrYlZIcG9qQlg0ZUx1cVJNQ3hkeVc1UkZFY3hML2o3OVF2VDVRK2ttRVlMRDJ3MlBxbU5xT2xScTM2QTkrCmNFYXRxeFpJMFN3Q3NYazJJMkhjUVFpNDRqMjNPcjJwbkxnKzI2Y3o2RTI4OHpSQ2ViTG5tL2h3L1FFMUtNRjYKZGp1WGc5QktjV09RcHNZMVRCbW45a2tTa2tQWUp4ZWdDVmdPcTA5UTI4VUNXZEVFVi9zVkZYRnBnTWxWZFRoZApXR2FuSEdZUGJzUnFPQXRGVk5Ob0dJcnhwbE1RRHloNWY3NXBEUkFyNFhCcjh5WllTRFdCK09BdmFNczVzekowClJzWnlwbFY0cDlsM1RQN2hqWGh6U0dZdkI0cjNCT2VYL0FqSlFobnJNR1R4RnNrWmhjRnc2OEdUb0NFQ0F3RUEKQVFLQ0FnQUQ5d3Zad0JqeWU5QVFaQlg5d3hHL09oMHhrNFR6MlhtaE5sYjVXUlRpNFhFTXNPdlhudzhySGR0NQpiSWs5NGF1alg2cjE1a0pCd1U2Vit3TitVemF2SFRBTG1MUHBQWWE2MlQ0b2U1aEkrZ3pBZzJZT1c4ZGV6NXowCi9OT3E5ZkhXTFh2MDFZRjFwbTQwemRtTW0xQmZ4OVJ6WmpmNUl3anNTYnpINEIwTGQ3YmI4VHE5blF4R0xCdlUKOE44b0NxaG1iRmpTVkx1WlZ3UU16cFR1eFJJbXRjWmwxeWVxdi83RXBFNkRCQTF1QTVSY1BVM0k4WWliN0dZSQp5RmtQbmtsbnRLZkFMQ3BJUFIveWw2VFdrTXN0dUQ4MnVhUHVPcSs3UWxxWHBOTi9hTUwrM0JlTFJKQWQrb21iCmp6Nk9zUGZZVFJkQy9SZzJEUC9hUHk0SGRub1lmQkxlb28xVTI0RjdUZVI3cGVGNnh0bDljSEUvWndHajFWMm4KYmh2UXY0azczWWVGb1dvZEVXenFuVmVyeFB6UHd2TUZXUFlTWCs1NkswV1FNZTgvd2xucHVjdGd1RXF5UWp3RwpVckNsVTVudUVuQ09lMHp3NlA3VzJyWW1IdXV0RlpIN1MxeWlvcHA1ODRCRE43N1lrWnBWeDNkQWZjQUREdnZuCjBvNXFPZmIrMEZOS1VNWjdzZE1DK243S0FFTjNjQ2Q3Sm8rdE93SVU2bmxmRWY0TnhLMzlIcjhPZWwxQnBuSlgKTEdhRHlNUmlybjdjbWRRSmtUODRjd2Z2ZnZsRHdpN040WE5DSnZIT0IralZCajFWYUI4K3RoKzBKMkJVWTBkaQozeXFYTThHZUh5blRqRU9pVHY3RFQ1cEg3dkR6UzRKQ3BybVdoMmduNGZTc0x0NzA4UUtDQVFFQTNlY01QSnArClNVUi8rcUZGYXZaNHAvb2swdlgwTG9sdnlESlNVM0tFaGFML3E0UUFZSjJDR1BOK3lVckNGZDhpU2N0azZmRUkKMlMwdXQraVdRZk5xeUozMUg1WS81aVpxUk9PTlZXWjNvd2hqTU80NTRZTk5laWlHRWxENldJaFJjMUo1YTZBYQpLUTFPeHZjTENlYkJsejRKSVdMNVBIUld4Q0NWSkU5YW4rdDRUUlJhYXQ3cmFHMmluQVBVaEJINkluMXlCRFZECkg1OVI0WENqc2FzZEJQY25sNW9tWExjOTdhQkdVeWRnVllqeDNvd3ZBWDBOcmQ0RU5iZGFVVlRSVEd0djFCK2MKTFd1OFZ2ZWtMbDJIck5mWmN4Y0dHMnZjbHRSRkljQThHdVNGWkJ1Q3AwSHpXaVBxYlJzQlhteDJWQ09oUkN3Rgo1QVlDRUpwK3lCcnZyUUtDQVFFQXpCTUdqNG1Ma01oQ3pjNDJXQ014Smt2K3BZZnpaWHRLdk4ydndIS01BYzdRCjFJVUVaL3BaSGZYNnNOTENDNkU1YUJsOFNDYUtqZXhxdDQ1ams2WXlsTHFjWUhkWkNnVE4vTDBzWEtEQkJwU2cKUEZKcmpub0lJL2l2M2p0aTdacE91L2o3b2RIcHUxK1hxeis3b0VoTnp1SWxEL2R1THZrMTc1YjhaLzRSV3VEMAoycXlYZi9VdWp2YXAzTGZVR1p6bGhZcmRTUnZrNkR3VmcxK0RkZ0d5N21qTFVrK2QxbVplYjErMjNWeWFKT094ClpkMUtJck5Eallndkp2akdTcDJhZlJNMXlzMjNUcXZscXM1N01nVFR5MzNETStDYU9sMXd3d25Ja1hoRDVBVVIKczg2c2RnemV3VWZQVGg3MGh3R2MwSHpGSjFtc0t5L2VvNnUwcmFQd3hRS0NBUUVBdGhac01pYk1UaThKblk1TQp1bEw1KzAwR2ZwNFkrejhJSFEwK0JQL0p3eWRZQ1ZST1F2bTgwZUN0UDF3N0cxdDRkWG1UbTJ5UXlEV05TcGh2CkJEdE1lc2N6Wi9JUkNUaW9wMUxhblNOeU5MUWpRUG1iUVhSUFZWaC9lL1E3R2Y3eVoyRmNCWGJoUUtLTTdETzQKT1MzRDJlbXI4RnVaRFlTaDFscXVSNWRlVkRBVERaMFAvUFpqMGROMVJmVFdwSEZrQW4xUjNDWWdxSWhCMW01cAp4TmNXL3dZWTFReEhRbm1UTmJUNVFDN2xuQXE5L3RLbGwrRVlJbjQya2lXYzFYUjJNdkZPV0pCL3hiM01WTWp0ClRxYXRPS1grNTdRUzdObDdyOEVMNFlBdlVob0hZM2czcEN3NEZ0VzEva1hVdjdqYytIb3NVUmFXMXVBZlBhU3AKT0dieUdRS0NBUUE0L2t0RHhSY3NUVEdUQnJkWXNDTm0zYXgxa0YxaWh5ZGRUZEJxdjlMb0lsbGlNUEFGRmY3VApoa0lJSmlRNVdVS09GeWdGZ25ZSm92QSs2VTVZQ3Y5dldCcWFPbHFzbUtEcXArNSt4QXFFaXZlaFFTZDJ1QkFUCjg3MHlKSVhCYytudlIxOEhWM2VlYzlrSTQ1akQ3ODJETE5kSytVQlZjQlluSHBUSmVrUmdqQmoyQldPZVFkeEoKNHd1WGIrT1ZiNk1PUTdUL1dRSDU5ZVhRTmRtaUdHRmZnZmJldXd1S3VEWkJob3Fza2RNZTRGUkg3YUJweG9UawpQeGRrRy9CTklHem41M2lMZGg1dW8wVldDYXFRVXBiUDZ3U2NOV3I5UitGWkp4OVR1VEhFdWNHeTVOSjNlYXF3CmNoeXNaYXJIRmFVMCtOT2E1TWxYbWx2a2Urek8zYzA5QW9JQkFERE1QWWtLcStxYVR0MjZQOFhnaTBLVlRGczkKWWd6OXZiQ2hYUHg0LzVBKzF3eUVCTmpFL1Fhb3EzelhhZ28rcHBUYnFkc1lZZFNOUUd3ZkJ3dkJLbFFUSGZrLwpVK1VBUk1uOFlIanN6T2ZZTVAwdUNLWTJMRGFFT3FPZ2hTR1d6Qm40Tm90bnFXTEV0SGZsUWFSK2dNLzRhaTlqCnYyVy9FRlRsaU03S1hOQXpTcTArNmF3QnB3TUo3dXhJTzdCU1phTFE5Q1Y5c2c5MTdVU1BmNWJqUG51aFA0VXAKWXdqZ0VQajVEUVl2U215bXdNWmpVc2J1TFVjSENTN2hFbzEvVlQ3REtvTWxyZDAxaWpKak9xZEtBV2p3SzhZMgovUTRzU3NHNUZYb3kyVVMwU01aZElraVFFL1dYVlp5ZHBHWXpadTBCNzVrbW9wMmx1NDlGdVo0dllIUT0KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K
---
kind: ValidatingWebhookConfiguration
apiVersion: admissionregistration.k8s.io/v1beta1
metadata:
  name: immutable-checker
webhooks:
  - name: immutable-checker.default.svc
    clientConfig:
      service:
        name: immutable-checker
        namespace: default
        path: "/"
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUV6RENDQXJRQ0NRRHFwRXBqVTVIQ3FUQU5CZ2txaGtpRzl3MEJBUXNGQURBb01TWXdKQVlEVlFRRERCMXAKYlcxMWRHRmliR1V0WTJobFkydGxjaTVrWldaaGRXeDBMbk4yWXpBZUZ3MHlNREF5TVRnd05qVXhORFJhRncwMApOekEzTURZd05qVXhORFJhTUNneEpqQWtCZ05WQkFNTUhXbHRiWFYwWVdKc1pTMWphR1ZqYTJWeUxtUmxabUYxCmJIUXVjM1pqTUlJQ0lqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FnOEFNSUlDQ2dLQ0FnRUE5VXFDaysyNDZ3cUQKTXlIUUJMUGNndFg2bVVDTFE2LzcyTWJEeWVFSGc2UGpWb1N2MTZ1VDZqc083MkpoRnhHUlNoNzIzR2VxWVQrNAo0dDRrak11K3N6QjBnbnhzd2lLc00rQWhCYW5sYzV3N1RqQzYxVU8yT0svUDN5aWxiZGdMeVpTQU9SY3dVd09qCmEvQkdEa3pLWUlEdEJiL1AvMG1wdFFnMWFRc3hudlhVMTJscEsyUkp5dDY5SSt4YlVWMm9KbExFZklZTGpTY2YKZW9yVmVOWlJHSW1xSXRZeUhYU0Z5T08ra3AxOWhSK09SS1ZjcWFzT1BJVEFVcUFyVE15SjZzSmZ0TEVTK043cgpuN2RLdmV2QWhnMUxRM0JaOEJZZ3M2VnZVWXZ6VlEzMkJBVlpWcEpiaGtjNzlvUXErdUZqQXpQcFRid0M4OFpVClBMOGZhM2hsRTFjTDVmdHVMY1NkdTd5OTNvUVAwbVNKR0xBbWQyanZFN2tYNXNXMzYrWG9nWk9ydDM2Z3UrSzIKUHFBb3ZOZmU3M1Y4dWFQdzhNblQ5SHhDK3FqT0NoaDdKQnA4dnhwcUhhUjBENVk3ZTUzcjN1dWpXV3BBWURabAozb0FPT3RSNi9VaVUrUzI0NWU4QnFNYmxFbVlENlJrRFFwaTROWXk3QWZqUy96c05penU5L3hnaEFySWhkZURUClZoejJoVWtQcURiaWtmWTVNMjNxZzhMWVZ2WC9wSGdOYmVIVnVQVmRWblN1dHJDNDhOQXljSFNIY3AvQ1UrMkkKN01Oa04yWkNsdEE3LzBzR3AzWFY4cHBndHMxU2ozcFVMcU5idkdnRVp1RVBFU1Q3S3FhbHdwZ01XcFJRUXZXago3SzdLeDgydThRakkxUXF5YVY5S24ycEtEaEJBUGpNQ0F3RUFBVEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBZ0VBCm9HUWVFbjRMdmdCekJ3aGFjZGFyOTRuYy81M293WXNBc0xyT2tYc3NnWHFtVHhuM05hRXNBSDR1R0RaZXNFNmcKbEd4RERjM0d4V1ltaGNza2NPdkJmQTg0bCszcCt4MnErdTdYRFR1Y2tTMmJJUmtkMU44VG8yOEtKL1p4aUtFdQpwQklXZDAvRmtpK05XbkcxUXV3R3VVVmk5NzdMRzZheXdzaHdXYW5zNE1JUVdyRWlwRGVNY1Y4NDRVS3dnSTFrClBwSHBUbVVlZytoV1F5aUU1YVRydmw3Y0tKbEszNXN6MUlYaStJRXJPWlU3OFJoM0l5L1lZM0dUL0QvRFJ3ek0Kei9qa3F0d1A1TzkxdU1aekMzejI5UWlsbmY0bytxckQ3c2EzT1hFelZ6L3M3bFRsdUUydW53NFZxT3NDcUljTQpDNjdZZkJGeGhzSGVTWTl1bllCZlU1enNqc2ZuM0F0S2Qvd3dUUXZLNk1GUExBU1lOMzF5OUpYOElGdnRzVEZ4CnlPTFpidU0yN1d3WG83dXU0Mmo5UHBYSFZWeTI4OTk3anRjSU9qZ1ltYkZjRzRDcEpEM2tGVmk1ZFRZK2RDbzIKRDUwSTFzRTNmMUI5S2xpNmRkUWVoVkhXV3NETUh5TlV4M2laYXFYaVFWWXdBd3VTa0VZMnlLcnRNdjVtR1VtbwpkdE80SUxScFpvYW9BRlp4SlJadVdFeDhLMVpEZ0JCOFVJeWtGMUU2dythK3ZKMGpvR2tQNVhFWjluSzlQQ3FQCmszMmFWRHZISytBbHZXbDJNZnNFZlVpRUFPNjllYzJJKzRpL0NXQm52MWxWQU4zNEFKL1NwdVVDbDMxLzljU0UKV2hkSk1MdFkyQk9xMGVWd2sxTkUvUjU5YUZNc1U1WTc1akQ2N1NOcXNQST0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
    rules:
      - operations: [ "CREATE", "UPDATE" ]
        apiGroups: ["*"]
        apiVersions: ["*"]
        resources: ["*"]
